language: php

php:
    - '7.1'
    - '7.2'
    - '7.3'
    - '7.4'

env:
    - DEPENDENCIES=lowest
    - DEPENDENCIES=highest

cache:
    directories:
        - ~/.composer/cache

jobs:
    exclude:
        # symfony/console fails on "YamlStandards\Command\YamlCommandTest::testCorrectRunCommandForFix -> Trying to access array offset on value of type int" and I think it's not necessary fix it, so I skip it
        -   php: '7.4'
            env: DEPENDENCIES=lowest
    include:
        -   name: "PHP: 7.1"
            language: sh
            os: windows
            env:
                - PHP_VERSION=7.1.31
                - DEPENDENCIES=lowest
            install:
                - git config --global core.autocrlf input
                - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
                - cd $TRAVIS_REPO_SLUG
                - git checkout -qf $TRAVIS_COMMIT
            before_script:
                ./.github/build/travis-windows-build-before-script.sh
            script: skip
        -   name: "PHP: 7.1"
            language: sh
            os: windows
            env:
                - PHP_VERSION=7.1.31
                - DEPENDENCIES=highest
            install:
                - git config --global core.autocrlf input
                - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
                - cd $TRAVIS_REPO_SLUG
                - git checkout -qf $TRAVIS_COMMIT
            before_script:
                ./.github/build/travis-windows-build-before-script.sh
            script: skip

        -   name: "PHP: 7.2"
            language: sh
            os: windows
            env:
                - PHP_VERSION=7.2.20
                - DEPENDENCIES=lowest
            install:
                - git config --global core.autocrlf input
                - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
                - cd $TRAVIS_REPO_SLUG
                - git checkout -qf $TRAVIS_COMMIT
            before_script:
                ./.github/build/travis-windows-build-before-script.sh
            script: skip
        -   name: "PHP: 7.2"
            language: sh
            os: windows
            env:
                - PHP_VERSION=7.2.20
                - DEPENDENCIES=highest
            install:
                - git config --global core.autocrlf input
                - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
                - cd $TRAVIS_REPO_SLUG
                - git checkout -qf $TRAVIS_COMMIT
            before_script:
                ./.github/build/travis-windows-build-before-script.sh
            script: skip

        -   name: "PHP: 7.3"
            language: sh
            os: windows
            env:
                - PHP_VERSION=7.3.8
                - DEPENDENCIES=lowest
            install:
                - git config --global core.autocrlf input
                - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
                - cd $TRAVIS_REPO_SLUG
                - git checkout -qf $TRAVIS_COMMIT
            before_script:
                ./.github/build/travis-windows-build-before-script.sh
            script: skip
        -   name: "PHP: 7.3"
            language: sh
            os: windows
            env:
                - PHP_VERSION=7.3.8
                - DEPENDENCIES=highest
            install:
                - git config --global core.autocrlf input
                - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
                - cd $TRAVIS_REPO_SLUG
                - git checkout -qf $TRAVIS_COMMIT
            before_script:
                ./.github/build/travis-windows-build-before-script.sh
            script: skip

        -   name: "PHP: 7.4"
            language: sh
            os: windows
            env:
                - PHP_VERSION=7.4.1
                - DEPENDENCIES=highest
            install:
                - git config --global core.autocrlf input
                - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
                - cd $TRAVIS_REPO_SLUG
                - git checkout -qf $TRAVIS_COMMIT
            before_script:
                ./.github/build/travis-windows-build-before-script.sh
            script: skip


        -   name: "PHP: 7.1"
            language: sh
            os: osx
            env:
                - PHP_VERSION=7.1
                - DEPENDENCIES=lowest
            addons:
                homebrew:
                    packages:
                        - composer
            install:
                - curl -s http://php-osx.liip.ch/install.sh | bash -s ${PHP_VERSION}
                - export PATH=/usr/local/php5/bin:$PATH
        -   name: "PHP: 7.1"
            language: sh
            os: osx
            env:
                - PHP_VERSION=7.1
                - DEPENDENCIES=highest
            addons:
                homebrew:
                    packages:
                        - composer
            install:
                - curl -s http://php-osx.liip.ch/install.sh | bash -s ${PHP_VERSION}
                - export PATH=/usr/local/php5/bin:$PATH

        -   name: "PHP: 7.2"
            language: sh
            os: osx
            env:
                - PHP_VERSION=7.2
                - DEPENDENCIES=lowest
            addons:
                homebrew:
                    packages:
                        - composer
            install:
                - curl -s http://php-osx.liip.ch/install.sh | bash -s ${PHP_VERSION}
                - export PATH=/usr/local/php5/bin:$PATH
        -   name: "PHP: 7.2"
            language: sh
            os: osx
            env:
                - PHP_VERSION=7.2
                - DEPENDENCIES=highest
            addons:
                homebrew:
                    packages:
                        - composer
            install:
                - curl -s http://php-osx.liip.ch/install.sh | bash -s ${PHP_VERSION}
                - export PATH=/usr/local/php5/bin:$PATH

        # build for PHP 7.3 is skipped because it's error in PHP https://bugs.php.net/bug.php?id=77260 'preg_match(): JIT compilation failed: no more memory in phar' and I don't know how to fix it

        -   name: "PHP: 7.4"
            language: sh
            os: osx
            env:
                - PHP_VERSION=7.4
                - DEPENDENCIES=highest
            addons:
                homebrew:
                    packages:
                        - composer
            install:
                - curl -s http://php-osx.liip.ch/install.sh | bash -s ${PHP_VERSION}
                - export PATH=/usr/local/php5/bin:$PATH

before_script:
    - composer self-update
    - composer global require hirak/prestissimo
    - if [ "${DEPENDENCIES}" = "lowest" ]; then composer update --prefer-lowest --prefer-dist --no-interaction --no-progress; fi;
    - if [ "${DEPENDENCIES}" = "highest" ]; then composer update --prefer-dist --no-interaction --no-progress; fi;

script:
    - vendor/bin/phing build-ci
