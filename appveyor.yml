build: off
platform:
  - x86
  - x64
clone_folder: c:\projects\yaml-standards

environment:
  # PHP version must be exactly defined because command `choco search PHP --exact --all-versions` returns only last version, I don't know why. I hope in near future this error will be fixed
  matrix:
    - php_version: 7.1.31
      dependencies: lowest
    - php_version: 7.1.31
      dependencies: highest

    - php_version: 7.2.20
      dependencies: lowest
    - php_version: 7.2.20
      dependencies: highest

    - php_version: 7.3.8
      dependencies: lowest
    - php_version: 7.3.8
      dependencies: highest

cache:
  - C:\ProgramData\chocolatey\bin -> appveyor.yml
  - C:\ProgramData\chocolatey\lib -> appveyor.yml
  - C:\tools\php -> appveyor.yml
  - C:\Users\appveyor\AppData\Local\Composer

init:
  - SET PATH=C:\Program Files\OpenSSL;c:\tools\php;%PATH%
  - SET COMPOSER_NO_INTERACTION=1
  - SET PHP=1
  - SET ANSICON=121x90 (121x90)

install:
  - IF EXIST c:\tools\php (SET PHP=0)
  # `--version=$env:php_version` must be here because command `choco search php --exact --all-versions` returns only last version
  - ps: appveyor-retry cinst --params '""/InstallDir:C:\tools\php""' --ignore-checksums -y php --version ((choco search php --exact --all-versions --version=$env:php_version -r | select-string -pattern $env:php_version | sort { [version]($_ -split '\|' | select -last 1) } -Descending | Select-Object -first 1) -replace '[php|]','')
  - cd c:\tools\php
  - IF %PHP%==1 copy php.ini-production php.ini /Y
  - IF %PHP%==1 echo date.timezone="UTC" >> php.ini
  - IF %PHP%==1 echo extension_dir=ext >> php.ini
  - IF %PHP%==1 echo extension=php_openssl.dll >> php.ini
  - IF %PHP%==1 echo extension=php_mbstring.dll >> php.ini
  - IF %PHP%==1 echo extension=php_fileinfo.dll >> php.ini
  - IF %PHP%==1 echo extension=php_curl.dll >> php.ini
  - IF %PHP%==1 echo @php %%~dp0composer.phar %%* > composer.bat
  - appveyor-retry appveyor DownloadFile https://getcomposer.org/composer.phar
  - cd c:\projects\yaml-standards
  - composer self-update
  - composer global require hirak/prestissimo
  - IF %dependencies%==lowest appveyor-retry composer update --prefer-lowest --prefer-dist --no-interaction --no-progress
  - IF %dependencies%==highest appveyor-retry composer update --prefer-dist --no-interaction --no-progress

test_script:
  - phing build-ci
